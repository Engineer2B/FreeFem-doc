<!DOCTYPE html>

<html lang="en">
	<head>
		  <meta charset="UTF-8">
  <title>Algorithms & Optimizations</title>
  <link rel="icon" href="../_static/img/Symbol.png" />

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700,900" rel="stylesheet">

  <!-- FreeFEM theme specific -->
  <link rel="stylesheet" type="text/css" href="../_static/css/freefemtheme.css" />

  <!-- css -->
  <link rel="stylesheet" href="../_static/css/pygments_custom.css" type="text/css" />

  <!-- MathJax -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  <script src="../_static/js/mathjax-config.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	</head>
	<body>
		<header>
   <a class="header-logo" href="../introduction/index.html">
      <img alt="logo" title="FreeFEM documentation" src="../_static/img/FreeFem_Documentation_Logo_bleu.svg" />
   </a>

   <a class="header-github" href="https://github.com/FreeFem/FreeFem-sources" target="_blank">
      <i class="fab fa-github"></i>
      <p class="header-github-title" >
         FreeFEM on GitHub
      </p>

      <p class="header-github-stars" id="headerGithubStarsForks">
         <span id="headerGithubStars"></span> stars - <span id="headerGithubForks"></span> forks
      </p>
   </a>
</header>
<script async src="../_static/js/github.js"></script>
		
		<nav id="nav">
	<div style="display: none;">
		<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/download.html">Download FreeFEM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/download.html#latest-binary-packages">Latest binary packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/download.html#syntax-highlighters">Syntax highlighters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/installation.html">Installation guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/installation.html#easy-installation">Easy installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#windows-binary-installation">Windows binary installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#macos-x-binary-installation">MacOS X binary installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#arch-aur-package">Arch AUR package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/installation.html#text-editor">Text-editor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#atom">Atom</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#gedit">Gedit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/installation.html#compilation">Compilation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#branches-os-status">Branches / OS status</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#compilation-on-osx-10-13">Compilation on OSX (&gt;=10.13)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#compilation-on-ubuntu">Compilation on Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#compilation-on-arch-linux">Compilation on Arch Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#compilation-on-linux-with-intel-software-tools">Compilation on Linux with Intel software tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/installation.html#compilation-on-windows">Compilation on Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/installation.html#environment-variables-and-init-file">Environment variables and init file</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/contributing.html">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/contributing.html#bug-report">Bug report</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../introduction/contributing.html#concerning-the-freefem-documentation">Concerning the <strong>FreeFEM</strong> documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/contributing.html#concerning-the-freefem-compilation-or-usage">Concerning the <strong>FreeFEM</strong> compilation or usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/contributing.html#improve-content">Improve content</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/citation.html">Citation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/citation.html#if-you-use-freefem-please-cite-the-following-reference-in-your-work">If you use <strong>FreeFEM</strong>, please cite the following reference in your work:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../introduction/citation.html#apa">APA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/citation.html#iso690">ISO690</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/citation.html#mla">MLA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../introduction/citation.html#bibtex">BibTeX</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/authors.html">Authors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/index.html">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../documentation/notations.html">Notations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#generalities">Generalities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#sets-mappings-matrices-vectors">Sets, Mappings, Matrices, Vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#numbers">Numbers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#differential-calculus">Differential Calculus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#meshes">Meshes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/notations.html#finite-element-spaces">Finite Element Spaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/meshGeneration.html">Mesh Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#square">Square</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#border">Border</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#multi-border">Multi-Border</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#data-structures-and-read-write-statements-for-a-mesh">Data Structures and Read/Write Statements for a Mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#mesh-connectivity-and-data">Mesh Connectivity and data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#the-keyword-triangulate">The keyword “triangulate”</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#boundary-fem-spaces-built-as-empty-meshes">Boundary FEM Spaces Built as Empty Meshes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#remeshing">Remeshing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#movemesh">Movemesh</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#regular-triangulation-htriangle">Regular Triangulation: hTriangle</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#adaptmesh">Adaptmesh</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#trunc">Trunc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#splitmesh">Splitmesh</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#meshing-examples">Meshing Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#how-to-change-the-label-of-elements-and-border-elements-of-a-mesh">How to change the label of elements and border elements of a mesh</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#mesh-in-three-dimensions">Mesh in three dimensions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#cube">Cube</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#read-write-statements-for-a-mesh-in-3d">Read/Write Statements for a Mesh in 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#tetgen-a-tetrahedral-mesh-generator">TetGen: A tetrahedral mesh generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#reconstruct-refine-a-three-dimensional-mesh-with-tetgen">Reconstruct/Refine a three dimensional mesh with TetGen</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#moving-mesh-in-three-dimensions">Moving mesh in three dimensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#layer-mesh">Layer mesh</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#meshing-examples-1">Meshing examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/meshGeneration.html#build-a-3d-mesh-of-a-cube-with-a-balloon">Build a 3d mesh of a cube with a balloon</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#medit">Medit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#mshmet">Mshmet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#freeyams">FreeYams</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#mmg3d">mmg3d</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#a-first-3d-isotrope-mesh-adaptation-process">A first 3d isotrope mesh adaptation process</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/meshGeneration.html#build-a-2d-mesh-from-a-isoline">Build a 2d mesh from a isoline</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/finiteElement.html">Finite element</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#use-of-freefem-fespace-in-2d">Use of freefem fespace in 2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#use-of-fespace-in-3d">Use of fespace in 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#lagrangian-finite-elements">Lagrangian Finite Elements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/finiteElement.html#p0-element">P0-element</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/finiteElement.html#p1-element">P1-element</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/finiteElement.html#p2-element">P2-element</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#p1-nonconforming-element">P1 Nonconforming Element</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#other-fe-space">Other FE-space</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#vector-valued-fe-function">Vector Valued FE-function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/finiteElement.html#raviart-thomas-element">Raviart-Thomas Element</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#a-fast-finite-element-interpolator">A Fast Finite Element Interpolator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#keywords-problem-and-solve">Keywords: Problem and Solve</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/finiteElement.html#weak-form-and-boundary-condition">Weak Form and Boundary Condition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#parameters-affecting-solve-and-problem">Parameters affecting solve and problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#problem-definition">Problem definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#numerical-integration">Numerical Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#variational-form-sparse-matrix-pde-data-vector">Variational Form, Sparse Matrix, PDE Data Vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#interpolation-matrix">Interpolation matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/finiteElement.html#finite-elements-connectivity">Finite elements connectivity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/visualization.html">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/visualization.html#plot">Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/visualization.html#link-with-gnuplot">Link with gnuplot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/visualization.html#link-with-medit">Link with medit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/visualization.html#link-with-paraview">Link with Paraview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/visualization.html#link-with-matlab-and-octave">Link with Matlab© and Octave</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/algorithmsOptimization.html">Algorithms &amp; Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#conjugate-gradient-gmres">Conjugate Gradient/GMRES</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#algorithms-for-unconstrained-optimization">Algorithms for Unconstrained Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#example-of-usage-for-bfgs-or-cmaes">Example of usage for BFGS or CMAES</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#ipopt">IPOPT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#short-description-of-the-algorithm">Short description of the algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#ipopt-in-freefem">IPOPT in <strong>FreeFEM</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#some-short-examples-using-ipopt">Some short examples using IPOPT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#d-constrained-minimum-surface-with-ipopt">3D constrained minimum surface with IPOPT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#area-and-volume-expressions">Area and volume expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#derivatives">Derivatives</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/algorithmsOptimization.html#the-problem-and-its-script">The problem and its script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#the-nlopt-optimizers">The nlOpt optimizers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/algorithmsOptimization.html#optimization-with-mpi">Optimization with MPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/parallelization.html">Parallelization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/parallelization.html#mpi">MPI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#mpi-keywords">MPI Keywords</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#mpi-constants">MPI Constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#mpi-constructor">MPI Constructor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#mpi-functions">MPI Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#mpi-communicator-operator">MPI Communicator operator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#schwarz-example-in-parallel">Schwarz example in parallel</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#true-parallel-schwarz-example">True parallel Schwarz example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/parallelization.html#parallel-sparse-solvers">Parallel sparse solvers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#using-parallel-sparse-solvers-in-freefem">Using parallel sparse solvers in <strong>FreeFEM</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#sparse-direct-solver">Sparse direct solver</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#mumps-solver">MUMPS solver</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#superlu-distributed-solver">SuperLU distributed solver</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#pastix-solver">PaStiX solver</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#parallel-sparse-iterative-solver">Parallel sparse iterative solver</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#parms-solver">pARMS solver</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#interfacing-with-hips">Interfacing with HIPS</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#interfacing-with-hypre">Interfacing with HYPRE</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#domain-decomposition">Domain decomposition</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#communicators-and-groups">Communicators and groups</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#process">Process</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#points-to-points-communicators">Points to Points communicators</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/parallelization.html#global-operations">Global operations</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#hpddm-solvers">HPDDM solvers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#time-dependent-problem">Time dependent problem</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/parallelization.html#distributed-vectors-in-hpddm">Distributed vectors in HPDDM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/plugins.html">Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/plugins.html#gsl">gsl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/plugins.html#ffrandom">ffrandom</a></li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/plugins.html#mmap-semaphore">mmap / semaphore</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/developers.html">Developers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/developers.html#file-formats">File formats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#mesh-file-data-structure">Mesh file data structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#bb-file-type-to-store-solutions">bb file type to Store Solutions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#id1">BB file type to store solutions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#metric-file">Metric file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#list-of-am-fmt-amdba-meshes">List of AM_FMT, AMDBA Meshes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#sol-and-solb-files">sol and solb files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/developers.html#adding-a-new-finite-element">Adding a new finite element</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#some-notations">Some notations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#which-class-to-add">Which class to add?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/developers.html#dynamical-link">Dynamical link</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#a-first-example-myfunction-cpp">A first example myfunction.cpp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#example-discrete-fast-fourier-transform">Example: Discrete Fast Fourier Transform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#load-module-for-dervieux-p0-p1-finite-volume-method">Load Module for Dervieux P0-P1 Finite Volume Method</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/developers.html#more-on-adding-a-new-finite-element">More on Adding a new finite element</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/developers.html#the-bernardi-raugel-element">The Bernardi-Raugel Element</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/developers.html#the-morley-element">The Morley Element</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/ffddm/index.html">ffddm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../documentation/ffddm/introddm.html">Domain Decomposition (DD)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/introddm.html#mesh-decomposition">Mesh Decomposition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/introddm.html#distributed-linear-algebra">Distributed Linear Algebra</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/introddm.html#partition-of-unity-matrices-poum">Partition of Unity Matrices (POUM)</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/introddm.html#distributed-scalar-product">Distributed scalar product</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/introddm.html#update">Update</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/introddm.html#distributed-matrix-and-vector-resulting-from-a-variational-formulation">Distributed Matrix and Vector resulting from a variational formulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/introddm.html#distributed-linear-solvers">Distributed Linear Solvers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/introddm.html#distributed-direct-solvers">Distributed Direct Solvers</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/introddm.html#schwarz-methods">Schwarz methods</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/introddm.html#restricted-additive-schwarz-ras">Restricted Additive Schwarz (RAS)</a></li>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/introddm.html#optimized-restricted-additive-schwarz-oras">Optimized Restricted Additive Schwarz (ORAS)</a></li>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/introddm.html#two-level-methods">Two level methods</a><ul>
<li class="toctree-l7"><a class="reference internal" href="../documentation/ffddm/introddm.html#coarse-mesh">Coarse Mesh</a></li>
<li class="toctree-l7"><a class="reference internal" href="../documentation/ffddm/introddm.html#geneo">GenEO</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/ffddm/documentation.html">ffddm documentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#minimal-example">Minimal example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#overlapping-mesh-decomposition">Overlapping mesh decomposition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#local-finite-element-spaces">Local finite element spaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#define-the-problem-to-solve">Define the problem to solve</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#one-level-preconditioners">One level preconditioners</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#two-level-preconditioners">Two level preconditioners</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/documentation.html#building-the-geneo-coarse-space">Building the GenEO coarse space</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/documentation.html#building-the-coarse-space-from-a-coarse-mesh">Building the coarse space from a coarse mesh</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#solving-the-linear-system">Solving the linear system</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/documentation.html#using-hpddm-within-ffddm">Using <em>HPDDM</em> within <em>ffddm</em></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/ffddm/parameters.html">Parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/parameters.html#command-line-arguments">Command-line arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/parameters.html#global-parameters">Global parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/ffddm/tutorial.html">Tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#what-is-ffddm">What is <strong>ffddm</strong> ?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#why-domain-decomposition-methods">Why Domain Decomposition Methods ?</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#step-1-decompose-the-mesh">Step 1: Decompose the mesh</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#step-2-define-your-finite-element">Step 2: Define your finite element</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/tutorial.html#distributed-vectors-and-restriction-operators">Distributed vectors and restriction operators</a></li>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/tutorial.html#partition-of-unity">Partition of unity</a></li>
<li class="toctree-l6"><a class="reference internal" href="../documentation/ffddm/tutorial.html#data-exchange-between-neighbors">Data exchange between neighbors</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#step-3-define-your-problem">Step 3: Define your problem</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#summary-so-far-translating-your-sequential-freefem-script">Summary so far: translating your sequential <em>FreeFEM</em> script</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#id1">Step 1: Decompose the mesh</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#solve-the-linear-system">Solve the linear system</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#solve-the-linear-system-with-the-parallel-direct-solver-mumps">Solve the linear system with the parallel direct solver <em>MUMPS</em></a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#step-4-define-the-one-level-dd-preconditioner">Step 4: Define the one level DD preconditioner</a></li>
<li class="toctree-l5"><a class="reference internal" href="../documentation/ffddm/tutorial.html#step-5-solve-the-linear-system-with-preconditioned-gmres">Step 5: Solve the linear system with preconditioned GMRES</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#define-a-two-level-dd-preconditioner">Define a two level DD preconditioner</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#build-the-geneo-coarse-space">Build the GenEO coarse space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#build-the-coarse-space-from-a-coarse-mesh">Build the coarse space from a coarse mesh</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#use-hpddm-within-ffddm">Use <strong>HPDDM</strong> within <strong>ffddm</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#some-results-heterogeneous-3d-elasticity-with-geneo">Some results: Heterogeneous 3D elasticity with GenEO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#some-results-2-level-dd-for-maxwell-equations-scattering-from-the-cobra-cavity">Some results: 2-level DD for Maxwell equations, scattering from the COBRA cavity</a></li>
<li class="toctree-l4"><a class="reference internal" href="../documentation/ffddm/tutorial.html#id2">Some results: 2-level DD for Maxwell equations, scattering from the COBRA cavity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../documentation/ffddm/examples.html">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="misc.html">Misc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="misc.html#poisson-s-equation">Poisson’s Equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="misc.html#poisson-s-equation-3d">Poisson’s equation 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="misc.html#stokes-equation-on-a-cube">Stokes Equation on a cube</a></li>
<li class="toctree-l3"><a class="reference internal" href="misc.html#cavity">Cavity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="meshGeneration.html">Mesh Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#square-mesh">Square mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#mesh-adaptation">Mesh adaptation</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#mesh-adaptation-for-the-poisson-s-problem">Mesh adaptation for the Poisson’s problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#uniform-mesh-adaptation">Uniform mesh adaptation</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#borders">Borders</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#change">Change</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#cube">Cube</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#empty-mesh">Empty mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#points">3 points</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#bezier">Bezier</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#build-layer-mesh">Build layer mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="meshGeneration.html#sphere">Sphere</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="finiteElement.html">Finite Element</a><ul>
<li class="toctree-l3"><a class="reference internal" href="finiteElement.html#periodic-3d">Periodic 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="finiteElement.html#lagrange-multipliers">Lagrange multipliers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="visualization.html">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="visualization.html#plot">Plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="visualization.html#hsv">HSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="visualization.html#medit">Medit</a></li>
<li class="toctree-l3"><a class="reference internal" href="visualization.html#paraview">Paraview</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Algorithms &amp; Optimizations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#algorithms">Algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmaes-variational-inequality">CMAES variational inequality</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ipopt-minimal-surface-volume">IPOPT minimal surface &amp; volume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmaes-mpi-variational-inequality">CMAES MPI variational inequality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallelization.html">Parallelization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#mpi-gmres-2d">MPI-GMRES 2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#mpi-gmres-3d">MPI-GMRES 3D</a></li>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#direct-solvers">Direct solvers</a></li>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#solver-mumps">Solver MUMPS</a></li>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#solver-superlu-dist">Solver superLU_DIST</a></li>
<li class="toctree-l3"><a class="reference internal" href="parallelization.html#solver-pastix">Solver PaStiX</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="developers.html">Developers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="developers.html#fft">FFT</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#complex">Complex</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#string">String</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#elementary-function">Elementary function</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#array">Array</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#block-matrix">Block matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#matrix-operations">Matrix operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#matrix-inversion">Matrix inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#fe-array">FE array</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#loop">Loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#implicit-loop">Implicit loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#i-o">I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#file-stream">File stream</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#command-line-arguments">Command line arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#macro">Macro</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#basic-error-handling">Basic error handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#error-handling">Error handling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

	</div>

	<div class="nav-links" id="staticNav">
	</div>

	<button class="nav-btn" onclick="openNav()"><i class="fa fa-bars"></i></button>

	<div id="sideNav" class="sidenav">
		<div class="sideNavHeader">
			<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   id="Calque_1"
   data-name="Calque 1"
   viewBox="0 0 380.98 113.39"
   version="1.1"
   sodipodi:docname="Logo.svg"
   inkscape:version="0.92.4 5da689c313, 2019-01-14">
  <metadata
     id="metadata30">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1920"
     inkscape:window-height="1016"
     id="namedview28"
     showgrid="false"
     inkscape:zoom="1.1312929"
     inkscape:cx="194.02578"
     inkscape:cy="53.159222"
     inkscape:window-x="0"
     inkscape:window-y="27"
     inkscape:window-maximized="1"
     inkscape:current-layer="Calque_1" />
  <defs
     id="defs4">
    <style
       id="style2">.cls-1{fill:blue;}.cls-2{fill:#00007f;}</style>
  </defs>
  <title
     id="title6">Logo</title>
  <path
     class="cls-2"
     d="M397.36,291H381.81v14.22h-11V267.42h27.75v8.44H381.74v6.67H397.3V291Z"
     transform="translate(-230.46 -229.51)"
     id="path13" />
  <path
     class="cls-2"
     d="M417.29,292.68H413v12.51H402V267.42h16.7c4.89,0,8.76,1,11.49,3a9.55,9.55,0,0,1,4.13,8.32,12.59,12.59,0,0,1-1.59,6.73,11.85,11.85,0,0,1-5.33,4.38l8.19,15v.44H423.77ZM413,284.24h5.71c3.18,0,4.76-1.4,4.76-4.25s-1.71-4.13-5.08-4.13H413Z"
     transform="translate(-230.46 -229.51)"
     id="path15" />
  <path
     class="cls-2"
     d="M465.8,289.89H450.94v6.86h17.59v8.44H440V267.42h28.76v8.44H450.94v5.59H465.8Z"
     transform="translate(-230.46 -229.51)"
     id="path17" />
  <path
     class="cls-2"
     d="M497.6,289.89H482.75v6.86h17.58v8.44H471.77V267.42h28.75v8.44H482.75v5.59H497.6Z"
     transform="translate(-230.46 -229.51)"
     id="path19" />
  <path
     class="cls-2"
     d="M530.11,291H514.55v14.22h-11V267.42h27.75v8.44H514.49v6.67h15.56V291Z"
     transform="translate(-230.46 -229.51)"
     id="path21" />
  <path
     class="cls-2"
     d="M560.58,289.89H545.73v6.86h17.58v8.44H534.74V267.42H563.5v8.44H545.73v5.59h14.85Z"
     transform="translate(-230.46 -229.51)"
     id="path23" />
  <path
     class="cls-2"
     d="M581.09,267.42,589,291.54l7.87-24.12h14.6v37.77h-11v-5.84l1.08-20.19-9,26h-7l-9-26,1.14,20.19v5.84h-11V267.42Z"
     transform="translate(-230.46 -229.51)"
     id="path25" />
  <g
     id="g833"
     transform="matrix(0.69996616,0,0,0.69996616,24.36493,-106.39712)">
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="181.58182"
       x="49.328617"
       height="86.368324"
       width="21.264048"
       id="rect1411"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="181.58182"
       x="64.966545"
       height="21.592081"
       width="53.160122"
       id="rect1413"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="218.71571"
       x="72.469795"
       height="16.194061"
       width="21.264048"
       id="rect1415"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="205.23866"
       x="95.834"
       height="86.368324"
       width="21.264048"
       id="rect1411-6"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="205.23866"
       x="111.47193"
       height="21.592081"
       width="53.160122"
       id="rect1413-7"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
    <rect
       transform="matrix(1,0,-0.17364818,0.98480775,0,0)"
       rx="3.1896071"
       y="242.37254"
       x="118.97518"
       height="16.194061"
       width="21.264048"
       id="rect1415-5"
       style="fill:#0000ff;fill-opacity:1;stroke:none;stroke-width:0.8504014;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
  </g>
</svg>
			<a class="closebtn" href="#" onclick="closeNav()"><i class="fas fa-times"></i></a>
		</div>
		<div id="dynamicSideNav">
		</div>
	</div>
	<script async src="../_static/js/lunr.js"></script>
<script async src="../_static/lunr/lunr_index.js"></script>

<div class="search-container">
	<label for="searchInput"><i class="fas fa-search"></i></label>
	<input type="search" placeholder="Search ..." id="searchInput">
	<div id="searchResults"></div>
</div>

<script src="../_static/js/search.js"></script>
<script>
   initSearch('../')
</script>
	
</nav>
<script async src="../_static/js/nav.js"></script>
		

		<div id="subnav">
	<div style="display: none">
		<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/index.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="misc.html">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="meshGeneration.html">Mesh Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="finiteElement.html">Finite Element</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualization.html">Visualization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Algorithms &amp; Optimizations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#algorithms">Algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmaes-variational-inequality">CMAES variational inequality</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ipopt-minimal-surface-volume">IPOPT minimal surface &amp; volume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmaes-mpi-variational-inequality">CMAES MPI variational inequality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallelization.html">Parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html">Developers</a></li>
</ul>
</li>
</ul>

	</div>
</div>
<script async src="../_static/js/subnav.js"></script>
		
		<div id="content">
			
   <div class="section" id="algorithms-optimizations">
<span id="examplealgorithmsoptimization"></span><h1>Algorithms &amp; Optimizations<a class="headerlink" href="#algorithms-optimizations" title="Permalink to this headline"> </a></h1>
<div class="section" id="algorithms">
<span id="examplealgorithms"></span><h2>Algorithms<a class="headerlink" href="#algorithms" title="Permalink to this headline"> </a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">debugJ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">debugdJ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">umax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Algorithms tests</span>
<span class="p">{</span>
    <span class="kt">func</span> <span class="kt">bool</span> <span class="kp">stop</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iter</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">u</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">g</span><span class="p">){</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; stop = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">iter</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">g</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="kr">linfty</span> <span class="o">&lt;</span> <span class="mf">1e-5</span> <span class="o">||</span> <span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// minimization of J(u) = 1./2 * sum (i+1) u_i^2 - b_i</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">//J</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//the gradiant of J (this is a affine version (the RHS is in)</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="n">u</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ-b: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//return of global variable ok</span>
    <span class="p">}</span>

    <span class="c1">//the gradiant of the bilinear part of J (the RHS is remove)</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">DJ0</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">debugdJ</span><span class="p">)</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dJ0: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//return of global variable ok</span>
    <span class="p">}</span>

    <span class="c1">//erro calculation</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="n">error</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nf">abs</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">matId</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">){</span> <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="n">verb</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span> <span class="c1">//verbosity</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span> <span class="c1">//set right hand side</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="c1">//set initial gest</span>

    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Affine) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="kp">stop</span><span class="o">=</span><span class="kp">stop</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Affine with stop) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearCG</span><span class="p">(</span><span class="n">DJ0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGC (Linear) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">AffineGMRES</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;AffineGMRES (Affine) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nf">LinearGMRES</span><span class="p">(</span><span class="n">DJ0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;LinearGMRES (Linear) : J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nf">NLCG</span><span class="p">(</span><span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">matId</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="n">verb</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;NLCG: J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="n">nerr</span> <span class="o">+=</span> <span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>


    <span class="c1">//warning: BFGS use a full matrix of size nxn (where n=u.n)</span>
    <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="nf">BFGS</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">DJ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kp">eps</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nbiterline</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;BFGS: J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, err = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nerr</span><span class="p">)</span> <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sol: u =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>

    <span class="nf">assert</span><span class="p">(</span><span class="n">nerr</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">{</span> <span class="c1">// A real non linear test</span>
    <span class="c1">// Parameters</span>
    <span class="kt">real</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>
    <span class="kt">real</span> <span class="kp">eps</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
    <span class="c1">//f(u) = a*u + u-ln(1+u), f&#39;(u) = a+ u/(1+u), f&#39;&#39;(u) = 1/(1+u)^2</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">f</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">u</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">u</span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">df</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">ddf</span><span class="p">(</span><span class="kt">real</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">u</span><span class="p">));</span> <span class="p">}</span>

    <span class="c1">// Mesh</span>
    <span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

    <span class="c1">// Fespace</span>
    <span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
    <span class="n">Vh</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">fespace</span> <span class="nf">Ph</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P0</span><span class="p">);</span>
    <span class="n">Ph</span> <span class="n">alpha</span><span class="p">;</span> <span class="c1">//store df(|nabla u|^2)</span>

    <span class="c1">// The functionnal J</span>
    <span class="c1">//J(u) = 1/2 int_Omega f(|nabla u|^2) - int_Omega u b</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">w</span><span class="p">;</span>
        <span class="n">w</span><span class="p">[]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J(u) = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">min</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="p">.</span><span class="kr">max</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The gradiant of J</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">dJ</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">w</span><span class="p">;</span>
        <span class="n">w</span><span class="p">[]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">));</span>
        <span class="kt">varf</span> <span class="nf">au</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
            <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                  <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">))</span>
                <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">vh</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">au</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//warning: no return of local array</span>
    <span class="p">}</span>

    <span class="c1">// Problem</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
    <span class="kt">varf</span> <span class="nf">alap</span> <span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">vh</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="kt">varf</span> <span class="nf">amass</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="n">uh</span><span class="o">*</span><span class="n">vh</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">uh</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="kt">matrix</span> <span class="n">Amass</span> <span class="o">=</span> <span class="n">amass</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">CG</span><span class="p">);</span>
    <span class="kt">matrix</span> <span class="n">Alap</span><span class="o">=</span> <span class="n">alap</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">,</span> <span class="kp">factorize</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Preconditionner</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">C</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">u</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">Alap</span><span class="o">^-</span><span class="mi">1</span><span class="o">*</span><span class="n">w</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span> <span class="c1">//warning: no return of local array variable</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">int</span> <span class="n">conv</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="nf">NLCG</span><span class="p">(</span><span class="n">dJ</span><span class="p">,</span> <span class="n">u</span><span class="p">[],</span> <span class="kp">nbiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="kp">precon</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="kp">veps</span><span class="o">=</span><span class="kp">eps</span><span class="p">,</span> <span class="kr">verbosity</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conv</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
        <span class="n">Alap</span> <span class="o">=</span> <span class="n">alap</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">solver</span><span class="o">=</span><span class="kr">Cholesky</span><span class="p">,</span> <span class="kp">factorize</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Restart with new preconditionner &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">conv</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, eps =&quot;</span> <span class="o">&lt;&lt;</span> <span class="kp">eps</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Plot</span>
    <span class="nf">plot</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;solution with NLCG&quot;</span><span class="p">);</span>
    <span class="n">umax</span> <span class="o">=</span> <span class="n">u</span><span class="p">[].</span><span class="kr">max</span><span class="p">;</span>

    <span class="n">Vh</span> <span class="n">sss</span><span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
    <span class="nf">plot</span> <span class="p">(</span><span class="n">sss</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="nf">assert</span><span class="p">(</span><span class="n">nerr</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="figure compound align-center" id="Algorithms">
<div style="width: 49%" class="subfigure" id="id1">
<a class="reference internal image-reference" href="../_images/Algorithms1.png"><img alt="Algorithms1" src="../_images/Algorithms1.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-number">Fig. 100 </span><span class="caption-text">Result <code class="docutils literal highlight highlight-freefem"><span></span><span class="n">u</span></code></span></p>
</div>
<div style="width: 49%" class="subfigure" id="id2">
<a class="reference internal image-reference" href="../_images/Algorithms2.png"><img alt="Algorithms2" src="../_images/Algorithms2.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-number">Fig. 101 </span><span class="caption-text"><code class="code freefem docutils literal highlight highlight-freefem"><span></span><span class="n">df</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">u</span><span class="p">))</span></code></span></p>
</div>
<p class="caption"><span class="caption-text">Algorithms</span></p>
</div></div>
<div class="section" id="cmaes-variational-inequality">
<span id="examplecmaesvariationalinequality"></span><span id="Algorithms"></span><h2>CMAES variational inequality<a class="headerlink" href="#cmaes-variational-inequality" title="Permalink to this headline"> </a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;ff-cmaes&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">NN</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">starttol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">bctol</span> <span class="o">=</span> <span class="mf">6.e-12</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">pena</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">ou1</span><span class="p">,</span> <span class="n">ou2</span><span class="p">;</span>

<span class="c1">// Mesh adaptation loops</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">al</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">al</span><span class="p">){</span>
    <span class="c1">// Problem</span>
    <span class="kt">varf</span> <span class="n">BVF</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="mf">0.5</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">;</span>
    <span class="kt">varf</span> <span class="nf">LVF1</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f1</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="nf">LVF2</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f2</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>

    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span>  <span class="n">BVF</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">LVF1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">LVF2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

    <span class="kt">varf</span> <span class="nf">Vbord</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Vh</span> <span class="n">In</span><span class="p">,</span> <span class="n">Bord</span><span class="p">;</span>
    <span class="n">Bord</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Vbord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">In</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bord</span><span class="p">[]</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh1</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh2</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g2</span><span class="p">;</span>

    <span class="c1">// Function which creates a vector of the search space type from</span>
    <span class="c1">// two finite element functions</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">FEFToSSP</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Splits a vector from the search space and fills</span>
    <span class="c1">// two finite element functions with it</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">SSPToFEF</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh1</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh2</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">IneqC</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">constraints</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">constraints</span><span class="p">.</span><span class="kr">l2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>
        <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">u1</span><span class="p">[],</span> <span class="n">u2</span><span class="p">[],</span> <span class="n">X</span><span class="p">);</span>
        <span class="n">iter</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Au1</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u1</span><span class="p">[],</span> <span class="n">Au2</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u2</span><span class="p">[];</span>
        <span class="n">Au1</span> <span class="o">-=</span> <span class="n">b1</span><span class="p">;</span>
        <span class="n">Au2</span> <span class="o">-=</span> <span class="n">b2</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">val</span> <span class="o">=</span> <span class="n">u1</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au1</span> <span class="o">+</span> <span class="n">u2</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au2</span><span class="p">;</span>
        <span class="n">val</span> <span class="o">+=</span>  <span class="n">pena</span> <span class="o">*</span> <span class="n">IneqC</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">%</span><span class="mi">200</span> <span class="o">==</span> <span class="mi">199</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;adapt level &quot;</span><span class="o">+</span><span class="n">al</span><span class="o">+</span><span class="s">&quot; - iteration &quot;</span><span class="o">+</span><span class="n">iter</span><span class="o">+</span><span class="s">&quot; - J = &quot;</span><span class="o">+</span><span class="n">val</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">val</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">start</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">al</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
        <span class="n">start</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">FEFToSSP</span><span class="p">(</span><span class="n">ou1</span><span class="p">[],</span> <span class="n">ou2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="kt">real</span> <span class="n">mini</span> <span class="o">=</span> <span class="nf">cmaes</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stopMaxFunEval</span><span class="o">=</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">stopTolX</span><span class="o">=</span><span class="mf">1.e-3</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">initialStdDev</span><span class="o">=</span><span class="p">(</span><span class="mf">0.025</span><span class="o">/</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">al</span><span class="p">))));</span>
    <span class="n">Vh</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">;</span>
    <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">best1</span><span class="p">[],</span> <span class="n">best2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">);</span>
    <span class="n">ou1</span> <span class="o">=</span> <span class="n">best1</span><span class="p">;</span>
    <span class="n">ou2</span> <span class="o">=</span> <span class="n">best2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id3">
<a class="reference internal image-reference" href="../_images/CMAESVariationalInequality.png"><img alt="../_images/CMAESVariationalInequality.png" src="../_images/CMAESVariationalInequality.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-number">Fig. 102 </span><span class="caption-text">Results</span></p>
</div>
</div>
<div class="section" id="ipopt-minimal-surface-volume">
<span id="exampleipoptminimalsurfacevolume"></span><h2>IPOPT minimal surface &amp; volume<a class="headerlink" href="#ipopt-minimal-surface-volume" title="Permalink to this headline"> </a></h2>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;msh3&quot;</span><span class="p">;</span>
<span class="cp">load</span> <span class="s">&quot;</span><span class="nf">medit</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">load</span> <span class="s">&quot;ff-Ipopt&quot;</span><span class="p">;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">np</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">regtest</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">shapeswitch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="kp">sigma</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">40.</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">-</span><span class="n">r0</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">E</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="kt">real</span> <span class="n">RR</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">rr</span><span class="p">);</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="kr">x</span><span class="p">,</span> <span class="kr">pi</span><span class="o">*</span><span class="kr">y</span><span class="p">]);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
<span class="c1">//Initial shape definition</span>
<span class="c1">//outside of the mesh adaptation loop to initialize with the previous optimial shape found on further iterations</span>
<span class="n">Vh</span> <span class="n">startshape</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">uz</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">lz</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>

<span class="c1">// Mesh adaptation loop</span>
<span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">lm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">kkk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">kkk</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">kkk</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">iter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">func</span> <span class="n">sin2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">));</span>

    <span class="c1">// A function which transform Th in 3d mesh (r=rho)</span>
    <span class="c1">//a point (theta,phi) of Th becomes ( r(theta,phi)*cos(theta)*sin(phi) , r(theta,phi)*sin(theta)*sin(phi) , r(theta,phi)*cos(phi) )</span>
    <span class="c1">//then displays the resulting mesh with medit</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">Plot3D</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">rho</span><span class="p">,</span> <span class="kt">string</span> <span class="kp">cmm</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">ffplot</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rhoo</span><span class="p">;</span>
        <span class="n">rhoo</span><span class="p">[]</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
        <span class="c1">//mesh sTh = square(np, np/2, [2*pi*x, pi*y]);</span>
        <span class="c1">//fespace sVh(sTh, P1);</span>
        <span class="c1">//Vh rhoplot = rhoo;</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="kt">mesh3</span> <span class="n">Sphere</span> <span class="o">=</span> <span class="nf">movemesh23</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">transfo</span><span class="o">=</span><span class="p">[</span><span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rhoo</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)]);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ffplot</span><span class="p">)</span>
                <span class="nf">plot</span><span class="p">(</span><span class="n">Sphere</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nf">medit</span><span class="p">(</span><span class="kp">cmm</span><span class="p">,</span> <span class="n">Sphere</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(...){</span>
            <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;PLOT ERROR&quot;</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Surface computation</span>
    <span class="c1">//Maybe is it possible to use movemesh23 to have the surface function less complicated</span>
    <span class="c1">//However, it would not simplify the gradient and the hessian</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Area</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">Vh</span> <span class="n">rho2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">rho4</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho2</span><span class="p">);</span>
        <span class="kt">real</span> <span class="n">res</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">rho4</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">square</span><span class="p">(</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">))));</span>
        <span class="o">++</span><span class="n">iter</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nf">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="kr">true</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;rho(theta,phi) on [0,2pi]x[0,pi] - S=&quot;</span><span class="o">+</span><span class="n">res</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">Plot3D</span><span class="p">(</span><span class="n">rho</span><span class="p">[],</span> <span class="s">&quot;shape_evolution&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">GradArea</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">,</span> <span class="n">rho2</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">rho2</span><span class="p">[]</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">sqrtPsi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="n">Vh</span> <span class="n">dxrho2</span> <span class="o">=</span> <span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">dyrho2</span> <span class="o">=</span> <span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">sqrtPsi</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">);</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">varf</span> <span class="n">dArea</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="p">;</span>

        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">dArea</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">matrix</span> <span class="n">hessianA</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">HessianArea</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">,</span> <span class="n">rho2</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">rho2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
        <span class="n">Vh</span> <span class="n">sqrtPsi</span><span class="p">,</span> <span class="n">sqrtPsi3</span><span class="p">,</span> <span class="n">C00</span><span class="p">,</span> <span class="n">C01</span><span class="p">,</span> <span class="n">C02</span><span class="p">,</span> <span class="n">C11</span><span class="p">,</span> <span class="n">C12</span><span class="p">,</span> <span class="n">C22</span><span class="p">,</span> <span class="kp">A</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="n">Vh</span> <span class="n">C0</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">;</span>
            <span class="n">Vh</span> <span class="n">dxrho2</span> <span class="o">=</span> <span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">dyrho2</span> <span class="o">=</span> <span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">sqrtPsi</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">);</span>
            <span class="n">sqrtPsi3</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">)</span><span class="o">*</span><span class="n">sqrtPsi</span><span class="p">;</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dxrho2</span> <span class="o">+</span> <span class="n">rho</span><span class="o">*</span><span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">C2</span> <span class="o">=</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">);</span>
            <span class="n">C00</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C0</span><span class="p">);</span>
            <span class="n">C01</span> <span class="o">=</span> <span class="n">C0</span><span class="o">*</span><span class="n">C1</span><span class="p">;</span>
            <span class="n">C02</span> <span class="o">=</span> <span class="n">C0</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
            <span class="n">C11</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C1</span><span class="p">);</span>
            <span class="n">C12</span> <span class="o">=</span> <span class="n">C1</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
            <span class="n">C22</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">C2</span><span class="p">);</span>
            <span class="kp">A</span> <span class="o">=</span> <span class="mf">6.</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span> <span class="o">+</span> <span class="n">dxrho2</span> <span class="o">+</span> <span class="n">dyrho2</span><span class="o">*</span><span class="n">sin2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">varf</span> <span class="n">d2Area</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="o">=</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
                <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi</span> <span class="o">*</span> <span class="p">(</span>
                      <span class="kp">A</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">rho2</span><span class="o">*</span><span class="n">sin2</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">sqrtPsi3</span> <span class="o">*</span> <span class="p">(</span>
                      <span class="n">C00</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C01</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C01</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C02</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
                    <span class="o">+</span> <span class="n">C02</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C11</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C12</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C12</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">C22</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="p">;</span>
        <span class="n">hessianA</span> <span class="o">=</span> <span class="n">d2Area</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">hessianA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Volume computation</span>
    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Volume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="n">Vh</span> <span class="n">rho3</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">res</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">rho3</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">GradVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="kt">varf</span> <span class="nf">dVolume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">rho</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="p">);</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">dVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">hessianV</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">HessianVolume</span><span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">rho</span><span class="p">;</span>
        <span class="n">rho</span><span class="p">[]</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span>
        <span class="kt">varf</span> <span class="n">d2Volume</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
        <span class="n">hessianV</span> <span class="o">=</span> <span class="n">d2Volume</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">hessianV</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//if we want to use the volume as a constraint function</span>
    <span class="c1">//we must wrap it in some freefem functions returning the appropriate type</span>
    <span class="c1">//The lagrangian hessian also have to be wrapped since the Volume is not linear with</span>
    <span class="c1">//respect to rho, it will constribbute to the hessian.</span>
    <span class="kt">func</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">ipVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">vol</span> <span class="o">=</span> <span class="p">[</span><span class="n">Volume</span><span class="p">(</span><span class="n">X</span><span class="p">)];</span> <span class="k">return</span> <span class="n">vol</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">mdV</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">ipGradVolume</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">)</span> <span class="p">{</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">]</span> <span class="n">dvol</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">);</span> <span class="n">dvol</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">:</span><span class="p">)</span> <span class="o">=</span> <span class="n">GradVolume</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="n">mdV</span> <span class="o">=</span> <span class="n">dvol</span><span class="p">;</span> <span class="k">return</span> <span class="n">mdV</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">matrix</span> <span class="n">HLagrangian</span><span class="p">;</span>
    <span class="kt">func</span> <span class="kt">matrix</span> <span class="nf">ipHessianLag</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">,</span> <span class="kt">real</span> <span class="n">objfact</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lambda</span><span class="p">){</span>
        <span class="n">HLagrangian</span> <span class="o">=</span> <span class="n">objfact</span><span class="o">*</span><span class="n">HessianArea</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">HessianVolume</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HLagrangian</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//building struct for GradVolume</span>
    <span class="kt">int</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">gvi</span><span class="p">(</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">),</span> <span class="n">gvj</span><span class="o">=</span><span class="mi">0</span><span class="o">:</span><span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">gvi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">Vh</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">startshape</span><span class="p">;</span> <span class="c1">//the starting value</span>
    <span class="n">Vh</span> <span class="n">ub</span> <span class="o">=</span> <span class="mf">1.e19</span><span class="p">;</span> <span class="c1">//bounds definition</span>
    <span class="n">Vh</span> <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">Gaussian</span> <span class="p">(</span><span class="kt">real</span> <span class="n">X</span><span class="p">,</span> <span class="kt">real</span> <span class="n">Y</span><span class="p">,</span> <span class="kt">real</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">real</span> <span class="n">phi</span><span class="p">){</span>
        <span class="kt">real</span> <span class="n">deltax2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">Y</span><span class="p">)),</span> <span class="n">deltay2</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">phi</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">deltax2</span> <span class="o">+</span> <span class="n">deltay2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="kp">sigma</span><span class="o">*</span><span class="kp">sigma</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="n">disc1</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">RR</span><span class="o">+</span><span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="kr">x</span><span class="p">));</span>
    <span class="kt">func</span> <span class="n">disc2</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">RR</span><span class="o">+</span><span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="n">sin2</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">r0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">q</span><span class="p">){</span>
            <span class="kt">func</span> <span class="n">f</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="p">,</span> <span class="kr">pi</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
            <span class="kt">func</span> <span class="n">g</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="o">+</span><span class="kr">pi</span><span class="o">/</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">2.</span><span class="o">*</span><span class="kr">pi</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">g</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">rr</span><span class="o">*</span><span class="n">Gaussian</span><span class="p">(</span><span class="kr">x</span><span class="p">,</span> <span class="kr">y</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="kr">pi</span><span class="p">,</span> <span class="kr">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="kr">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="kr">max</span><span class="p">(</span><span class="n">disc1</span><span class="p">,</span> <span class="n">disc2</span><span class="p">));</span>
    <span class="kt">real</span> <span class="n">Vobj</span> <span class="o">=</span> <span class="n">Volume</span><span class="p">(</span><span class="n">lb</span><span class="p">[]);</span>
    <span class="kt">real</span> <span class="n">Vnvc</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="kr">pi</span><span class="o">*</span><span class="nf">pow</span><span class="p">(</span><span class="n">lb</span><span class="p">[].</span><span class="kr">linfty</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Plot3D</span><span class="p">(</span><span class="n">lb</span><span class="p">[],</span> <span class="s">&quot;object_inside&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">clb</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cub</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">Vobj</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">Vnvc</span><span class="p">];</span>

    <span class="c1">// Call IPOPT</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IPOPT</span><span class="p">(</span><span class="n">Area</span><span class="p">,</span> <span class="n">GradArea</span><span class="p">,</span> <span class="n">ipHessianLag</span><span class="p">,</span> <span class="n">ipVolume</span><span class="p">,</span> <span class="n">ipGradVolume</span><span class="p">,</span>
            <span class="n">rc</span><span class="p">[],</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">[],</span> <span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">[],</span> <span class="n">clb</span><span class="o">=</span><span class="n">clb</span><span class="p">,</span> <span class="n">cub</span><span class="o">=</span><span class="n">cub</span><span class="p">,</span> <span class="n">checkindex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">kkk</span><span class="o">&lt;</span><span class="n">nadapt</span><span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">40</span><span class="o">:</span><span class="mi">150</span><span class="p">,</span>
            <span class="n">warmstart</span><span class="o">=</span><span class="n">kkk</span><span class="p">,</span> <span class="n">lm</span><span class="o">=</span><span class="n">lm</span><span class="p">,</span> <span class="n">uz</span><span class="o">=</span><span class="n">uz</span><span class="p">[],</span> <span class="n">lz</span><span class="o">=</span><span class="n">lz</span><span class="p">[],</span> <span class="kp">tol</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">structjacc</span><span class="o">=</span><span class="p">[</span><span class="n">gvi</span><span class="p">,</span><span class="n">gvj</span><span class="p">]);</span>
    <span class="kr">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IPOPT: res =&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="kr">endl</span> <span class="p">;</span>

    <span class="c1">// Plot</span>
    <span class="n">Plot3D</span><span class="p">(</span><span class="n">rc</span><span class="p">[],</span> <span class="s">&quot;Shape_at_&quot;</span><span class="o">+</span><span class="n">kkk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">Plot3D</span><span class="p">(</span><span class="n">GradArea</span><span class="p">(</span><span class="n">rc</span><span class="p">[]),</span> <span class="s">&quot;ShapeGradient&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kkk</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">rc</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rc</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">x</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span> <span class="n">rc</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="kr">y</span><span class="p">),</span>
            <span class="kp">nbvx</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="kp">periodic</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="kr">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kr">y</span><span class="p">]]);</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="kp">wait</span><span class="o">=</span><span class="kr">true</span><span class="p">);</span>
        <span class="n">startshape</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
        <span class="n">uz</span> <span class="o">=</span> <span class="n">uz</span><span class="p">;</span>
        <span class="n">lz</span> <span class="o">=</span> <span class="n">lz</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">regtest</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">rc</span><span class="p">[];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id4">
<a class="reference internal image-reference" href="../_images/IPOPTMinimalSurfaceVolume.png"><img alt="../_images/IPOPTMinimalSurfaceVolume.png" src="../_images/IPOPTMinimalSurfaceVolume.png" style="width: 50%;" /></a>
<p class="caption"><span class="caption-number">Fig. 103 </span><span class="caption-text">Mesh</span></p>
</div>
</div>
<div class="section" id="cmaes-mpi-variational-inequality">
<span id="examplecmaesmpivariationalinequality"></span><h2>CMAES MPI variational inequality<a class="headerlink" href="#cmaes-mpi-variational-inequality" title="Permalink to this headline"> </a></h2>
<p>Command:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ff-mpirun -np <span class="m">4</span> CMAESMPIVariationalInequality.edp -glut ffglut
</pre></div>
</td></tr></table></div>
<div class="highlight-freefem notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">load</span> <span class="s">&quot;mpi-cmaes&quot;</span>

<span class="c1">// Parameters</span>
<span class="kt">int</span> <span class="n">NN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">f2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
<span class="kt">func</span> <span class="n">g2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nadapt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">starttol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">bctol</span> <span class="o">=</span> <span class="mf">6.e-12</span><span class="p">;</span>
<span class="kt">real</span> <span class="n">pena</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="c1">// Mesh</span>
<span class="kt">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="nf">square</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">);</span>

<span class="c1">// Fespace</span>
<span class="kt">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="nc">P1</span><span class="p">);</span>
<span class="n">Vh</span> <span class="n">ou1</span><span class="p">,</span> <span class="n">ou2</span><span class="p">;</span>

<span class="c1">// Mehs adaptation loop</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">al</span> <span class="o">&lt;</span> <span class="n">nadapt</span><span class="p">;</span> <span class="o">++</span><span class="n">al</span><span class="p">){</span>
    <span class="c1">// Problem</span>
    <span class="kt">varf</span> <span class="n">BVF</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span>
              <span class="mf">0.5</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dx</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="nf">dy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">;</span>
    <span class="kt">varf</span> <span class="nf">LVF1</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f1</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">varf</span> <span class="nf">LVF2</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">f2</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
    <span class="kt">matrix</span> <span class="kp">A</span> <span class="o">=</span> <span class="n">BVF</span><span class="p">(</span><span class="n">Vh</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">LVF1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">LVF2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">);</span>

    <span class="kt">varf</span> <span class="nf">Vbord</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="nf">on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Vh</span> <span class="n">In</span><span class="p">,</span> <span class="n">Bord</span><span class="p">;</span>
    <span class="n">Bord</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Vbord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vh</span><span class="p">,</span> <span class="kp">tgv</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">In</span><span class="p">[]</span> <span class="o">=</span> <span class="n">Bord</span><span class="p">[]</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Vh</span> <span class="n">gh1</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g1</span><span class="p">,</span> <span class="n">gh2</span> <span class="o">=</span> <span class="n">Bord</span><span class="o">*</span><span class="n">g2</span><span class="p">;</span>

    <span class="c1">//Function which create a vector of the search space type from</span>
    <span class="c1">//two finite element functions</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">FEFToSSP</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">]</span> <span class="o">=</span> <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//Function spliting a vector from the search space and fills</span>
    <span class="c1">//two finite element functions with it</span>
    <span class="kt">func</span> <span class="kt">int</span> <span class="nf">SSPToFEF</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef1</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">fef2</span><span class="p">,</span> <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">kX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Vh</span><span class="p">.</span><span class="kr">ndof</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">In</span><span class="p">[][</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">[</span><span class="n">kX</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
                <span class="o">++</span><span class="n">kX</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
                <span class="n">fef1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh1</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
                <span class="n">fef2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gh2</span><span class="p">[][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">IneqC</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">constraints</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">];</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mf">0.</span> <span class="o">:</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">constraints</span><span class="p">.</span><span class="kr">l2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">func</span> <span class="kt">real</span> <span class="nf">J</span> <span class="p">(</span><span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">){</span>
        <span class="n">Vh</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">;</span>
        <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">u1</span><span class="p">[],</span> <span class="n">u2</span><span class="p">[],</span> <span class="n">X</span><span class="p">);</span>
        <span class="n">iter</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">Au1</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u1</span><span class="p">[],</span> <span class="n">Au2</span> <span class="o">=</span> <span class="kp">A</span><span class="o">*</span><span class="n">u2</span><span class="p">[];</span>
        <span class="n">Au1</span> <span class="o">-=</span> <span class="n">b1</span><span class="p">;</span>
        <span class="n">Au2</span> <span class="o">-=</span> <span class="n">b2</span><span class="p">;</span>
        <span class="kt">real</span> <span class="n">val</span> <span class="o">=</span> <span class="n">u1</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au1</span> <span class="o">+</span> <span class="n">u2</span><span class="p">[]</span><span class="o">&#39;*</span><span class="n">Au2</span><span class="p">;</span>
        <span class="n">val</span> <span class="o">+=</span>  <span class="n">pena</span> <span class="o">*</span> <span class="n">IneqC</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
        <span class="nf">plot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="kp">nbiso</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="kp">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="kp">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="kp">cmm</span><span class="o">=</span><span class="s">&quot;adapt level &quot;</span><span class="o">+</span><span class="n">al</span><span class="o">+</span><span class="s">&quot; - iteration &quot;</span><span class="o">+</span><span class="n">iter</span><span class="o">+</span><span class="s">&quot; - J = &quot;</span><span class="o">+</span><span class="n">val</span><span class="p">,</span> <span class="kp">value</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">val</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Solve</span>
    <span class="kt">real</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="n">start</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
        <span class="n">start</span><span class="p">(</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="n">In</span><span class="p">[].</span><span class="kr">sum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">FEFToSSP</span><span class="p">(</span><span class="n">ou1</span><span class="p">[],</span> <span class="n">ou2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="kt">real</span> <span class="n">mini</span> <span class="o">=</span> <span class="n">cmaesMPI</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stopMaxFunEval</span><span class="o">=</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">stopTolX</span><span class="o">=</span><span class="mf">1.e-4</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">al</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">initialStdDev</span><span class="o">=</span><span class="p">(</span><span class="mf">0.025</span><span class="o">/</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">al</span><span class="p">))));</span>
    <span class="n">Vh</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">;</span>
    <span class="n">SSPToFEF</span><span class="p">(</span><span class="n">best1</span><span class="p">[],</span> <span class="n">best2</span><span class="p">[],</span> <span class="n">start</span><span class="p">);</span>

    <span class="c1">// Mesh adaptation</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="nf">adaptmesh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">best1</span><span class="p">,</span> <span class="n">best2</span><span class="p">);</span>
    <span class="n">ou1</span> <span class="o">=</span> <span class="n">best1</span><span class="p">;</span>
    <span class="n">ou2</span> <span class="o">=</span> <span class="n">best2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="figure" id="id5">
<a class="reference internal image-reference" href="../_images/CMAESMPIVariationalInequality.png"><img alt="../_images/CMAESMPIVariationalInequality.png" src="../_images/CMAESMPIVariationalInequality.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-number">Fig. 104 </span><span class="caption-text">Result</span></p>
</div>
</div>
</div>


		</div>
		
		<div id="toc">
	<div>
		<b>Table of content</b>
		<ul>
<li><a class="reference internal" href="#">Algorithms &amp; Optimizations</a><ul>
<li><a class="reference internal" href="#algorithms">Algorithms</a></li>
<li><a class="reference internal" href="#cmaes-variational-inequality">CMAES variational inequality</a></li>
<li><a class="reference internal" href="#ipopt-minimal-surface-volume">IPOPT minimal surface &amp; volume</a></li>
<li><a class="reference internal" href="#cmaes-mpi-variational-inequality">CMAES MPI variational inequality</a></li>
</ul>
</li>
</ul>

	</div>
</div>
		<footer>
	<p>
		Coded with <i class="fas fa-heart"></i> since 1987
	</p>
	<img src='../_static/img/Symbole.svg' alt="FreeFEM logo"/>
	<div>
		<a id="lgpl" href="https://www.gnu.org/licenses/lgpl-3.0.txt" target="_blank">LGPL 3.0</a>
		<a href="http://doc.freefem.org/introduction/citation/" target="_blank">BibTeX</a>
	</div>
</footer>
		

		<script async src="../_static/js/common.js"></script>
	</body>
</html>